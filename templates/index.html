<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArborNote - Tree Detection Interface</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #2e8b57, #228b22);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            max-width: 1400px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .map-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h3 {
            color: #2e8b57;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #2e8b57;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #2e8b57;
            color: white;
        }

        .btn-primary:hover {
            background: #236b43;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-outline {
            background: white;
            color: #2e8b57;
            border: 2px solid #2e8b57;
        }

        .btn-outline:hover {
            background: #2e8b57;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .geofence-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        .divider-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            position: relative;
            margin: 0.5rem 0;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider-text::before {
            left: 0;
        }

        .divider-text::after {
            right: 0;
        }

        .kml-upload-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .upload-status {
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .area-info {
            background: linear-gradient(135deg, #e8f5e8, #d4f1d4);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .area-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .cost-highlight {
            background: #fff3cd;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            font-weight: 600;
        }

        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, #2e8b57, #32cd32);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        .map-search {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 400px;
        }

        .search-input-container {
            position: relative;
            display: flex;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: #2e8b57;
        }

        .search-input::placeholder {
            color: #999;
        }

        .search-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .search-button:hover {
            color: #2e8b57;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item.active {
            background: #e7f3ff;
            border-left: 3px solid #2e8b57;
        }

        .search-result-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.2rem;
        }

        .search-result-subtitle {
            font-size: 0.8rem;
            color: #666;
        }

        .search-loading {
            padding: 0.75rem 1rem;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .search-no-results {
            padding: 0.75rem 1rem;
            text-align: center;
            color: #999;
            font-size: 0.9rem;
        }

        /* Search marker custom styling */
        .search-marker {
            background: transparent !important;
            border: none !important;
        }

        .map-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .map-btn:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        .map-btn.active {
            background: #2e8b57;
            color: white;
            border-color: #2e8b57;
        }

        .results-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .tree-pin {
            background: transparent !important;
            border: none !important;
        }

        .tree-marker {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .tree-marker:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        .tree-popup {
            text-align: center;
        }

        .tree-popup h4 {
            margin-bottom: 8px;
            color: #2e8b57;
        }

        .tree-popup p {
            margin: 4px 0;
            font-size: 0.9rem;
        }

        .tree-pin.selected {
            background: #ffc107;
            border-color: #fd7e14;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            padding: 0.5rem;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .expandable {
            cursor: pointer;
            user-select: none;
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable.expanded .expandable-content {
            max-height: 500px;
        }

        .expandable::after {
            content: "▼";
            float: right;
            transition: transform 0.3s ease;
        }

        .expandable.expanded::after {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-tree"></i> ArborNote - Tree Detection Interface</h1>
                <div class="header-stats">
                    <span id="cost-display">Estimated Cost: $0</span>
                    <span id="area-display">Area: 0 acres</span>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Sidebar Controls -->
            <div class="sidebar">
                
                <!-- Geofence Creation -->
                <div class="section">
                    <h3><i class="fas fa-map-marked-alt"></i> Define Processing Area</h3>
                    
                    <div class="geofence-options">
                        <div class="btn-group">
                            <button id="btn-draw" class="btn btn-primary">
                                <i class="fas fa-pencil-alt"></i> Draw Polygon
                            </button>
                            <button id="btn-clear" class="btn btn-secondary" disabled>
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        
                        <div class="divider-text">OR</div>
                        
                        <div class="kml-upload-section">
                            <label for="kml-file-input" class="btn btn-outline">
                                <i class="fas fa-file-upload"></i> Upload KML File
                            </label>
                            <input type="file" id="kml-file-input" accept=".kml,.kmz" style="display: none;">
                            <div id="kml-upload-status" class="upload-status hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Area Information -->
                <div id="area-info" class="section hidden">
                    <h3><i class="fas fa-ruler-combined"></i> Area Details</h3>
                    <div class="area-info">
                        <div class="area-row">
                            <span>Area:</span>
                            <span id="area-acres">0 acres</span>
                        </div>
                        <div class="area-row">
                            <span>Square Meters:</span>
                            <span id="area-meters">0 m²</span>
                        </div>
                        <div class="area-row">
                            <span>Est. Time:</span>
                            <span id="estimated-time">0 minutes</span>
                        </div>
                    </div>
                    <div class="cost-highlight">
                        Total Cost: $<span id="total-cost">0</span>
                        <br><small>($500 per acre)</small>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section">
                    <h3><i class="fas fa-cog"></i> Processing Settings</h3>
                    
                    <div class="form-group">
                        <label for="imagery-date">Imagery Date</label>
                        <select id="imagery-date" class="form-control">
                            <option value="">Auto-detect latest available</option>
                        </select>
                        <small style="color: #666;">August-October, past 3 years</small>
                    </div>

                    <div class="form-group">
                        <label for="model-select">AI Model</label>
                        <select id="model-select" class="form-control">
                            <option value="model_65">Model 65 (Default)</option>
                        </select>
                    </div>

                    <!-- Advanced Settings (Expandable) -->
                    <div class="form-group">
                        <div class="expandable" onclick="toggleAdvanced()">
                            <label>Advanced Settings</label>
                        </div>
                        <div class="expandable-content" id="advanced-settings">
                            <div class="form-group">
                                <label for="confidence-threshold">Confidence Threshold</label>
                                <input type="number" id="confidence-threshold" class="form-control" 
                                       value="0.25" min="0.1" max="1.0" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label for="iou-threshold">IOU Threshold</label>
                                <input type="number" id="iou-threshold" class="form-control" 
                                       value="0.7" min="0.1" max="1.0" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label for="patch-size">Patch Size</label>
                                <select id="patch-size" class="form-control">
                                    <option value="400">400px</option>
                                    <option value="800">800px</option>
                                    <option value="1000" selected>1000px</option>
                                    <option value="1200">1200px</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="enable-postprocessing" checked>
                                    Enable Post-processing
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Controls -->
                <div class="section">
                    <h3><i class="fas fa-play"></i> Processing</h3>
                    
                    <button id="start-processing" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" disabled>
                        <i class="fas fa-play"></i> Start Tree Detection
                    </button>
                    
                    <button id="clear-map" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                        <i class="fas fa-trash"></i> Clear Map
                    </button>

                    <!-- Progress -->
                    <div id="progress-container" class="progress-container hidden">
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="progress-text" class="progress-text">Ready to start...</div>
                    </div>

                    <!-- Alerts -->
                    <div id="alerts"></div>
                </div>

                <!-- Results -->
                <div id="results-section" class="section hidden">
                    <h3><i class="fas fa-chart-bar"></i> Results</h3>
                    
                    <div class="results-section">
                        <p><strong>Trees Detected:</strong> <span id="tree-count">0</span></p>
                        <p><strong>Avg Confidence:</strong> <span id="avg-confidence">0%</span></p>
                        <p><strong>Processing Time:</strong> <span id="processing-time">0 min</span></p>
                    </div>

                    <div class="form-group">
                        <label>Download Files:</label>
                        <ul id="file-list" class="file-list"></ul>
                        
                        <button id="download-all" class="btn btn-primary" style="width: 100%;" disabled>
                            <i class="fas fa-download"></i> Download All Files
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <!-- Address Search -->
                <div class="map-search">
                    <div class="search-input-container">
                        <input type="text" id="address-search" class="search-input" placeholder="Search for an address or location..." autocomplete="off">
                        <button id="search-button" class="search-button" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="search-results" class="search-results"></div>
                </div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <button id="draw-polygon" class="map-btn" title="Draw Geofence">
                        <i class="fas fa-draw-polygon"></i>
                    </button>
                    <button id="edit-polygon" class="map-btn" title="Edit Geofence" disabled>
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="add-tree" class="map-btn" title="Add Tree Pin" disabled>
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="remove-tree" class="map-btn" title="Remove Tree Pin" disabled>
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
